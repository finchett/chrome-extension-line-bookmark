class Pin{constructor(e,t,i,n,s=""){this.index=n,this.anchorSelector=e,this.x=t,this.y=i,this.note=s,this.stick=!1,this.createParent(),this.refreshAnchor(),this.refreshPosition(),this.createElements(),document.documentElement.appendChild(this.pinParent)}refreshAnchor(){this.anchor=getAnchorFromSelector(this.anchorSelector),this.anchor.classList.add("pin-anchor")}highlightAnchor(){this.anchor.classList.add("anchor-highlight")}unlightAnchor(){this.anchor.classList.remove("anchor-highlight")}refreshPosition(){this.position=getOffsetPosition(this.anchor,this.x,this.y),this.pinParent.style.left=`${Math.max(15,Math.min(this.position.x-9.5,window.innerWidth-35))}px`,this.pinParent.style.top=`${Math.max(this.position.y-20,15)}px`}createParent(){this.pinParent=document.createElement("div"),this.pinParent.classList.add("pin-parent")}createElements(){this.pin=document.createElement("div"),this.pin.className="pin-line-bookmark bounceIn-line-bookmark",this.pin.setAttribute("data-index",this.index),this.pin.addEventListener("mouseenter",this.handlePinMouseEnter.bind(this)),this.pin.addEventListener("mouseenter",()=>this.pin.classList.add("hover")),this.pin.addEventListener("mouseleave",()=>this.pin.classList.remove("hover")),this.pin.addEventListener("mouseleave",this.handlePinMouseLeave.bind(this)),this.pin.addEventListener("click",e=>{e.stopPropagation(),removePin(this.pin)}),this.pinParent.appendChild(this.pin),this.noteDiv=document.createElement("div"),this.noteDiv.className="note-line-bookmark",this.noteDiv.addEventListener("mouseenter",()=>clearTimeout(this.mouseleaveTimeout)),this.noteDiv.addEventListener("click",e=>{this.stick=!0,e.stopPropagation()}),this.noteDiv.addEventListener("mouseup",e=>e.stopPropagation()),this.pinParent.addEventListener("mouseleave",()=>{this.stick||this.hideNote()}),this.pinParent.appendChild(this.noteDiv),this.noteText=document.createElement("div"),this.noteText.className="noteText-line-bookmark",this.noteText.setAttribute("contenteditable","true"),this.noteText.setAttribute("placeholder","Write a note..."),this.noteText.innerHTML=this.note,this.noteText.addEventListener("keyup",()=>this.updateNote()),this.noteDiv.appendChild(this.noteText)}handlePinMouseEnter(){this.showNote(),this.highlightAnchor()}handlePinMouseLeave(){this.unlightAnchor()}showNote(){if(!this.pinParent||!this.noteDiv)return;this.noteDiv.style.display="block";let e=this.pinParent.getBoundingClientRect(),t=window.innerWidth,i=this.noteDiv.style.marginLeft;this.noteDiv.style.marginLeft="0px";let n=this.noteDiv.offsetWidth;this.noteDiv.style.marginLeft=i;let s=e.left+n+20>t?`-${n-20}px`:"0px";this.noteDiv.style.marginLeft=s,this.noteDiv.classList.add("fadeIn"),this.noteDiv.style.visibility="visible"}hideNote(){this.pinParent&&(this.noteDiv.classList.remove("fadeIn"),this.stick=!1,setTimeout(()=>{this.noteDiv.style.display="none"},200))}updateNote(){delay(()=>{this.note=this.noteText.innerHTML,savePins()},1e3)}removeElement(){if(!this.pinParent)return;let e=()=>{this.pin.remove(),this.noteDiv.remove(),this.noteText.remove(),this.pinParent.remove(),this.pinParent=null};this.noteDiv.classList.contains("fadeIn")?this.noteDiv.addEventListener("transitionend",e,{once:!0}):e()}}const pins=[];let altKeyPressed=!1;const generateId=(()=>{let e=0;return()=>e++})();function handleAltClick(e){isNearExistingPin(e.pageX,e.pageY)||e.target.closest(".noteText-line-bookmark, .note-line-bookmark")||addNewPin(e.pageX,e.pageY)}function getOffsetPosition(e,t,i){if(!e)return null;let n=e.getBoundingClientRect(),s=n.left+window.scrollX+t,o=n.top+window.scrollY+i;return{x:s,y:o}}document.documentElement.addEventListener("click",e=>{altKeyPressed&&(handleAltClick(e),e.stopPropagation())}),document.documentElement.addEventListener("mouseup",e=>{pins.forEach(t=>{t.noteDiv&&t.noteDiv.classList.contains("fadeIn")&&!t.noteDiv.contains(e.target)&&t.hideNote()})}),document.documentElement.addEventListener("keydown",e=>{e.altKey&&(altKeyPressed=!0)}),document.documentElement.addEventListener("keyup",()=>{altKeyPressed=!1});const getUniqueSelector=e=>{let t=[],i;for(;i=e.parentNode;)t.unshift(`${e.tagName}:nth-child(${[].indexOf.call(i.children,e)+1})`),e=i;return`${t.join(" > ")}`.toLowerCase()};function yeuclideanDistance(e,t,i,n){return Math.sqrt((i-e)**2*.1+(n-t)**2)}function getScrollAnchor(e,t){let i=Array.from(document.querySelectorAll("p, section, article, body, main")),n=null,s=1/0,o=null,r=null;return i.forEach(i=>{let a=i.getBoundingClientRect();if(0===a.width||0===a.height||a.bottom<=0||a.top>=window.innerHeight)return;let l=a.left+window.scrollX,h=a.top+window.scrollY,c=Math.abs(yeuclideanDistance(l,h,e,t));c<s&&(s=c,n=i,o=e-l,r=t-h)}),{anchor:n,x:o,y:r}}function getAnchorFromSelector(e){return document.querySelector(e)}function addNewPin(e,t){let i=getScrollAnchor(e,t),n=getUniqueSelector(i.anchor);document.querySelector(n);let s=new Pin(n,i.x,i.y,generateId());s.showNote(),pins.push(s),savePins()}function removePin(e){e.classList.add("remove-pin-line-bookmark"),setTimeout(()=>{let t=pins.findIndex(t=>t.index==e.getAttribute("data-index"));if(-1!==t){let[i]=pins.splice(t,1);i.unlightAnchor(),i.removeElement()}e.remove(),savePins()},200)}function isNearExistingPin(e,t){return pins.some(i=>10>Math.hypot(e-i.x,t-i.y))}function savePins(){let e=pins.map(({anchorSelector:e,x:t,y:i,index:n,note:s})=>({anchorSelector:e,x:t,y:i,index:n,note:s})),t=window.location.origin+window.location.pathname;chrome.storage.local.set({[t]:e})}let delayTimer;function delay(e,t){clearTimeout(delayTimer),delayTimer=setTimeout(e,t)}function removeAllPins(){pins.forEach(e=>e.removeElement()),pins.length=0;let e=window.location.origin+window.location.pathname;chrome.storage.local.remove(e)}function loadPins(){let e=window.location.origin+window.location.pathname;chrome.storage.local.get(e,t=>{if(t[e]){let i=t[e];i.forEach(e=>{let t=new Pin(e.anchorSelector,e.x,e.y,e.index,e.note);pins.push(t)})}})}function scrollToNextPin(){if(0===pins.length)return;let e=[...pins].sort((e,t)=>e.position.y-t.position.y),t=0,i=-1;e.length>1&&(-1==(t=e.findIndex(e=>e.position.y>window.scrollY+120))?(i=e.length-1,t=0):i=t-1);let n=e[t];if(i>0){let s=e[i];s.hideNote()}n&&(""!==n.note&&n.showNote(),window.scrollTo({top:n.position.y-100,behavior:"smooth"}))}chrome.runtime.onMessage.addListener((e,t,i)=>{switch(e.type){case"getStatus":i(pins.length>0?"full":"empty");break;case"remove":removeAllPins(),i("done");break;default:console.error("Unrecognized message:",e)}}),window.addEventListener("load",loadPins),document.addEventListener("keydown",e=>{e.ctrlKey&&"x"===e.key&&scrollToNextPin()}),window.addEventListener("resize",()=>{pins.forEach(e=>{e.refreshPosition()})});