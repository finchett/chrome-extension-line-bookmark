class Pin{constructor(e,t,n,i,s=""){this.index=n,this.x=e,this.y=t,this.topScroll=i,this.note=s,this.stick=!1,this.createElements(),document.documentElement.appendChild(this.pinParent)}createElements(){this.pinParent=document.createElement("div"),this.pinParent.classList.add("pin-parent"),this.pinParent.style.left=`${this.x-9.5}px`,this.pinParent.style.top=`${this.y-20}px`,this.pin=document.createElement("div"),this.pin.className="pin-line-bookmark bounceIn-line-bookmark",this.pin.setAttribute("data-index",this.index),this.pin.addEventListener("mouseenter",this.handlePinMouseEnter.bind(this)),this.pin.addEventListener("mouseenter",()=>this.pin.classList.add("hover")),this.pin.addEventListener("mouseleave",()=>this.pin.classList.remove("hover")),this.pin.addEventListener("click",e=>{e.stopPropagation(),removePin(this.pin)}),this.pinParent.appendChild(this.pin),this.noteDiv=document.createElement("div"),this.noteDiv.className="note-line-bookmark",this.noteDiv.addEventListener("mouseenter",()=>clearTimeout(this.mouseleaveTimeout)),this.noteDiv.addEventListener("click",e=>{this.stick=!0,e.stopPropagation()}),this.noteDiv.addEventListener("mouseup",e=>e.stopPropagation()),this.pinParent.addEventListener("mouseleave",()=>{this.stick||this.hideNote()}),this.pinParent.appendChild(this.noteDiv),this.noteText=document.createElement("div"),this.noteText.className="noteText-line-bookmark",this.noteText.setAttribute("contenteditable","true"),this.noteText.setAttribute("placeholder","Write a note..."),this.noteText.innerHTML=this.note,this.noteText.addEventListener("keyup",()=>this.updateNote()),this.noteDiv.appendChild(this.noteText)}handlePinMouseEnter(){this.showNote()}showNote(){if(!this.pinParent||!this.noteDiv)return;this.noteDiv.style.display="block";let e=this.pinParent.getBoundingClientRect(),t=window.innerWidth,n=this.noteDiv.style.marginLeft;this.noteDiv.style.marginLeft="0px";let i=this.noteDiv.offsetWidth;this.noteDiv.style.marginLeft=n;let s=e.left+i+20>t?`-${i-20}px`:"0px";this.noteDiv.style.marginLeft=s,this.noteDiv.classList.add("fadeIn"),this.noteDiv.style.visibility="visible"}hideNote(){this.pinParent&&(this.noteDiv.classList.remove("fadeIn"),this.stick=!1,setTimeout(()=>{this.noteDiv.style.display="none"},200))}updateNote(){delay(()=>{this.note=this.noteText.innerHTML,savePins()},1e3)}removeElement(){if(!this.pinParent)return;let e=()=>{this.pin.remove(),this.noteDiv.remove(),this.noteText.remove(),this.pinParent.remove(),this.pinParent=null};this.noteDiv.classList.contains("fadeIn")?this.noteDiv.addEventListener("transitionend",e,{once:!0}):e()}}const pins=[];let altKeyPressed=!1;const generateId=(()=>{let e=0;return()=>e++})();function handleAltClick(e){isNearExistingPin(e.pageX,e.pageY)||e.target.closest(".noteText-line-bookmark, .note-line-bookmark")||addNewPin(e.pageX,e.pageY)}function addNewPin(e,t){let n=new Pin(e,t,generateId(),document.documentElement.scrollTop);n.showNote(),pins.push(n),savePins()}function removePin(e){e.classList.add("remove-pin-line-bookmark"),setTimeout(()=>{let t=pins.findIndex(t=>t.index==e.getAttribute("data-index"));if(-1!==t){let[n]=pins.splice(t,1);n.removeElement()}e.remove(),savePins()},200)}function isNearExistingPin(e,t){return pins.some(n=>10>Math.hypot(e-n.x,t-n.y))}function savePins(){let e=pins.map(({x:e,y:t,index:n,topScroll:i,note:s})=>({x:e,y:t,index:n,topScroll:i,note:s})),t=window.location.origin+window.location.pathname;chrome.storage.local.set({[t]:e})}document.documentElement.addEventListener("click",e=>{altKeyPressed&&(handleAltClick(e),e.stopPropagation())}),document.documentElement.addEventListener("mouseup",e=>{pins.forEach(t=>{t.noteDiv&&t.noteDiv.classList.contains("fadeIn")&&!t.noteDiv.contains(e.target)&&t.hideNote()})}),document.documentElement.addEventListener("keydown",e=>{e.altKey&&(altKeyPressed=!0)}),document.documentElement.addEventListener("keyup",()=>{altKeyPressed=!1});let delayTimer;function delay(e,t){clearTimeout(delayTimer),delayTimer=setTimeout(e,t)}function removeAllPins(){pins.forEach(e=>e.removeElement()),pins.length=0;let e=window.location.origin+window.location.pathname;chrome.storage.local.remove(e)}function loadPins(){let e=window.location.origin+window.location.pathname;chrome.storage.local.get(e,t=>{t[e]&&t[e].forEach(e=>{let t=new Pin(e.x,e.y,e.index,e.topScroll,e.note);pins.push(t)})})}function scrollToNextPin(){if(0===pins.length)return;let e=[...pins].sort((e,t)=>e.y-t.y),t=0,n=-1;e.length>1&&(-1==(t=e.findIndex(e=>e.y>window.scrollY+120))?(n=e.length-1,t=0):n=t-1);let i=e[t];n>0&&e[n].hideNote(),i&&(""!==i.note&&i.showNote(),window.scrollTo({top:i.y-100,behavior:"smooth"}))}chrome.runtime.onMessage.addListener((e,t,n)=>{switch(e.type){case"getStatus":n(pins.length>0?"full":"empty");break;case"remove":removeAllPins(),n("done");break;default:console.error("Unrecognized message:",e)}}),window.addEventListener("load",loadPins),document.addEventListener("keydown",e=>{e.ctrlKey&&"x"===e.key&&scrollToNextPin()});